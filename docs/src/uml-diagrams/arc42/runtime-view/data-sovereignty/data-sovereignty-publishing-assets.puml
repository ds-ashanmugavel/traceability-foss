@startuml

autonumber "<B>[00]"
skinparam monochrome true
skinparam shadowing false
skinparam defaultFontName "Architects daughter"
skinparam linetype ortho

title Policies: Send and receive assets

actor "Admin \n [A]" as AA
actor User
participant "Trace-X \n [A]" as TXA
participant "PolicyStore \n [A]" as PSA
participant "Digital Twin Registry \n [A]" as DTRA
participant "EDC \n [A]" as EDCA
participant "SubmodelServer \n [A]" as SSA
participant "Digital Twin Registry \n [B]" as DTRB
participant "EDC \n [B]" as EDCB
participant "IRS \n [B]" as IRSB
participant "PolicyStore \n [B]" as PSB
participant "Trace-X \n [B]" as TXB
actor "Admin B" as AB

AA -> TXA: create policy
note left
    create policy used for publishing
       company assets [POLICY_TRACEX-PUBLISH_ASSETS]
end note
activate TXA
TXA -> PSA: create policy for BPNL
activate PSA
TXA <-- PSA: 201 policy created
deactivate PSA
AA <-- TXA: policy created
deactivate TXA



...
User -> TXA: import assets (POST /assets/import)
activate TXA
User <-- TXA: ok
...

User -> TXA: publish selected assets in transient state

note left
 POST /assets/publish
end note

User <-- TXA: request for policy

User --> TXA: select policy to be used

loop selected assets

TXA -> EDCA: create asset (POST /v3/assets)
note left
    create assets and CatalogOffer in EDC
end note
TXA <-- EDCA: 200 Asset was created successfully.

TXA -> EDCA: PolicyDefinition exists
activate EDCA
TXA <-- EDCA: return PolicyDefinition exists
opt PolicyDefinition not exists
TXA -> EDCA: create PolicyDefinition (/management/v2/policydefinitions)
TXA <-- EDCA: PolicyDefinition created
else

end opt

TXA -> EDCA: create ContractDefinition (/management/v2/contractdefinitions) with policy
note left
    create ContractDefinition in EDC
end note
TXA <-- EDCA: ContractDefinition created

TXA -> DTRA: create asset /shell-descriptors
activate DTRA
note left
    create asset in DTR
end note
TXA <-- DTRA: 201 : Asset Administration Shell Descriptor created successfully
deactivate DTRA

TXA -> SSA: create submodels for twin
activate SSA
note left
    create submodels in SubmodelServer
end note
TXA <-- SSA: submodels created
deactivate SSA

deactivate EDCA
end


deactivate TXA

AB -> TXB: create policy
activate TXB


note right
    create policy for
    BPNL of Trace-X [A]
    [POLICY_BPNL_TRACEX_A]
end note
AB <-- TXB: policy created
deactivate TXB


ref over TXB
    Trace-X [B] publish own assets

end ref

note right
    Prerequisite is that Trace-X has published own assets.
    dDTR of Trace-X B is requested for globalAssetIds of company own assets. 
end note

...
TXB -> TXB: synchronize assets (assets/as-$/sync)
note left
    different endpoints for sync as-built and as-planned assets
end note
activate TXB
TXB -> DTRB: GET Asset Administration Shell Descriptors
activate DTRB
TXB <-- DTRB: 200 Requested Asset Administration Shell Descriptors
deactivate DTRB

TXB -> IRSB: Register job (GET /irs/jobs) - initiate Sync of assets
activate IRSB
IRSB -> EDCA: GET /v2/catalog/request of Trace-X A
note left
    (/v2/catalog/request/querySpec/filterExpression[id:digitalTwinRegistry])
end note
activate EDCA
EDCA --> IRSB: return CatalogOffer
deactivate EDCA
IRSB -> IRSB: extract policy definitions from CatalogOffer
IRSB -> PSB:  get policies for BPNL

activate PSB
IRSB <-- PSB: policy for BPNL
deactivate PSB

loop each part
IRSB -> IRSB: compare ContractOffer policy with Company policy for BPNL
alt policies match
    IRSB -> EDCB: start contract negotiation
    EDCB -> EDCA:  contract negotiation
    EDCB <-- EDCA: ok contractAgreement
    IRSB <-- EDCB: ok contractAgreement
    ref over IRSB, TXB: data consumption
else policies does not match
    IRSB -> IRSB: create Tombstone with policy (JobResponse)
end
end

TXB <-- IRSB : calback job response

@enduml
