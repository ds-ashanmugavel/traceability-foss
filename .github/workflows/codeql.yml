name: "[BE][SECURITY] CodeQL"

on:
  push:
    branches: main
    paths-ignore:
      - '**/*.md'
      - '**/*.txt'
  pull_request:
    branches: main
    paths-ignore:
      - '**/*.md'
      - '**/*.txt'
      - '.husky/**'
      - 'cypress/**'
      - 'charts/**'
      - 'dev/**'
      - 'docs/**'
      - 'tx-backend/ci/**'
      - 'tx-backend/collection/**'
      - 'tx-backend/openapi/**'
      - 'README.md'
      - 'CHANGELOG.md'
  schedule:
    - cron: '0 1 * * 1-5' # At 01:00 on every day-of-week from Monday through Friday.
  workflow_dispatch:
jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'java', 'javascript' ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Initializes the CodeQL tools for scanning.
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          config-file: ./.github/codeql/codeql-config.yml
          queries: +security-and-quality,security-extended

      # Dependencies installieren und builden
      - name: Install frontend dependencies
        if: ${{ matrix.language == 'javascript' }}
        run: |
          cd frontend
          npm install

      - name: Build frontend
        if: ${{ matrix.language == 'javascript' }}
        run: |
          cd frontend
          npm run build:prod
        env:
          baseHrefPlaceholder: placeholder

      - name: Set up JDK 17
        if: ${{ matrix.language == 'java' }}
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache maven packages
        if: ${{ matrix.language == 'java' }}
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Build Package
        if: ${{ matrix.language == 'java' }}
        run: |
          mvn clean package -pl tx-models,tx-backend --batch-mode -DskipTests

      # CodeQL Analyse
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          output: "codeql-results.sarif"
          upload: true

      - name: Upload SARIF results
        uses: actions/upload-artifact@v3
        with:
          name: codeql-results-java
          path: /home/runner/work/traceability-foss/traceability-foss/codeql-results.sarif/java.sarif
